<script>
  // ====== CONFIG (Render only) ======
  const API_BASE = "https://gamepulse-news-service.onrender.com";

  // ====== INIT LIBS ======
  AOS.init({ duration: 700, once: true });
  if (window.VANTA) {
    VANTA.GLOBE({
      el: "#vanta-bg", mouseControls: true, touchControls: true,
      minHeight: 200, minWidth: 200, scale: 1.0, scaleMobile: 1.0,
      color: 0x5f3dc4, backgroundColor: 0x0, size: 0.8
    });
  }

  // ====== STATE ======
  let ALL_ITEMS = [];
  let filtered = [];
  let sourceFilter = "All";
  let searchTerm = "";
  let visibleCount = 10;

  // ====== HELPERS ====== 
  const fallbackImg = (w,h) => `https://picsum.photos/${w}/${h}?random=${Math.floor(Math.random()*100000)}`;
  const fmtTime = iso => { try { return new Date(iso || Date.now()).toLocaleString(); } catch { return ""; } };
  const clean = html => (html || "").replace(/<[^>]+>/g,"");
  const setHTML = (el, html) => { el.innerHTML = html; if (window.feather) feather.replace(); };

  // ====== RENDERERS ======
  function renderTrending(items) {
    const tr = document.getElementById('trending');
    if (!tr) return;
    const top = items.filter(i => i.image).slice(0,3);
    if (!top.length) { tr.innerHTML = `<div class="text-gray-400">No trending items yet.</div>`; return; }
    tr.innerHTML = top.map((g, idx)=>`
      <div class="bg-gray-800 rounded-xl overflow-hidden shadow transition hover:-translate-y-1">
        <div class="relative h-48">
          <img src="${g.image || fallbackImg(1024,576)}" class="w-full h-full object-cover" alt="">
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
          <div class="absolute bottom-3 left-3">
            <span class="text-white text-xs ${idx===0?'bg-purple-600':'bg-red-500'} px-2 py-1 rounded">${idx===0?'NEW':'HOT'}</span>
          </div>
        </div>
        <div class="p-5">
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-lg font-bold">${g.title || 'Untitled'}</h3>
            <span class="text-xs bg-gray-700 text-purple-300 px-2 py-1 rounded">${g.source || ''}</span>
          </div>
          <p class="text-gray-400 text-sm line-clamp-2">${clean(g.description)}</p>
          <div class="mt-3 flex items-center justify-between">
            <div class="flex gap-2"><span class="chip">News</span><span class="chip">${g.source || 'Source'}</span></div>
            <a href="${g.link}" target="_blank" class="text-purple-400 hover:text-purple-300 text-sm">Open</a>
          </div>
        </div>
      </div>
    `).join('');
    if (window.feather) feather.replace();
  }

  function renderFeatured(item) {
    const el = document.getElementById('featured');
    if (!el) return;
    if (!item) { el.innerHTML = `<div class="p-6 text-gray-400">No news yet.</div>`; return; }
    setHTML(el, `
      <div class="relative h-64 md:h-80">
        <img src="${item.image || fallbackImg(1200,630)}" alt="" class="w-full h-full object-cover">
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
        <div class="absolute bottom-0 left-0 p-6">
          <span class="text-purple-400 text-xs">${item.source || ''}</span>
          <h3 class="text-2xl font-bold mt-1">${item.title || ''}</h3>
          <p class="text-gray-300 mt-2 line-clamp-2">${clean(item.description)}</p>
          <div class="flex items-center mt-3 text-sm text-gray-400">
            <i data-feather="clock" class="w-4 h-4 mr-1"></i><span>${fmtTime(item.pubDate)}</span>
            <a href="${item.link}" target="_blank" class="ml-4 text-purple-300 hover:text-purple-200 underline">Read more</a>
          </div>
        </div>
      </div>
    `);
  }

  function renderList(items) {
    const wrap = document.getElementById('list');
    if (!wrap) return;
    if (!items.length) { wrap.innerHTML = `<div class="p-6 text-gray-400 bg-gray-900 rounded-xl">No articles match your filter.</div>`; return; }
    const slice = items.slice(0, visibleCount);
    wrap.innerHTML = slice.map(i => `
      <div class="bg-gray-900 rounded-xl p-6 flex">
        <div class="w-24 h-24 mr-4 flex-shrink-0">
          <img src="${i.image || fallbackImg(200,200)}" class="w-full h-full object-cover rounded-lg" alt="">
        </div>
        <div class="min-w-0">
          <span class="text-blue-400 text-xs">${i.source || ''}</span>
          <h4 class="font-bold mt-1">${i.title || ''}</h4>
          <p class="text-gray-400 text-sm line-clamp-2">${clean(i.description)}</p>
          <div class="flex items-center mt-2 space-x-2 text-xs text-gray-400">
            <i data-feather="clock" class="w-3 h-3"></i>
            <span>${fmtTime(i.pubDate)}</span>
            <a href="${i.link}" target="_blank" class="ml-4 text-purple-400 hover:text-purple-300">Open</a>
          </div>
        </div>
      </div>
    `).join('');
    if (window.feather) feather.replace();
    const more = document.getElementById('loadMoreBtn');
    if (more) more.classList.toggle('hidden', items.length <= visibleCount);
  }

  function buildSourceTabs(items) {
    const tabs = document.getElementById('sourceTabs');
    if (!tabs) return;
    const sources = Array.from(new Set(items.map(i => i.source).filter(Boolean))).sort();
    const btn = (name, active=false) =>
      `<button data-source="${name}" class="px-3 py-1 rounded-lg border ${active?'border-purple-500 text-purple-300':'border-gray-700 text-gray-300 hover:border-purple-500 hover:text-purple-300'}">${name}</button>`;
    tabs.innerHTML = [btn("All", true), ...sources.map(s => btn(s))].join('');
    tabs.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        sourceFilter = b.dataset.source;
        tabs.querySelectorAll('button').forEach(x=>x.classList.remove('border-purple-500','text-purple-300'));
        b.classList.add('border-purple-500','text-purple-300');
        applyFilters();
      });
    });
  }

  function applyFilters() {
    const term = searchTerm.trim().toLowerCase();
    filtered = ALL_ITEMS.filter(i => {
      const okSource = (sourceFilter === "All") || ((i.source||"").toLowerCase() === sourceFilter.toLowerCase());
      const text = (i.title || '') + ' ' + clean(i.description || '');
      const okSearch = !term || text.toLowerCase().includes(term);
      return okSource && okSearch;
    });
    visibleCount = 10;
    renderFeatured(filtered[0]);
    renderList(filtered.slice(1));
  }

  // ====== Category lists (Reviews/Guides) ======
  const articleCard = (i) => `
    <div class="bg-gray-900 rounded-xl p-5 flex">
      <div class="w-24 h-24 mr-4 flex-shrink-0">
        <img src="${i.image || `https://picsum.photos/200?random=${Math.random()}`}" class="w-full h-full rounded-lg object-cover" alt="">
      </div>
      <div class="min-w-0">
        <div class="text-xs text-blue-400">${i.source || ""}</div>
        <div class="font-semibold mt-1">${i.title || ""}</div>
        <div class="text-gray-400 text-sm line-clamp-2">${clean(i.description)}</div>
        <div class="text-xs text-gray-500 mt-1">${fmtTime(i.pubDate)}</div>
        <a href="${i.link}" target="_blank" class="inline-block mt-2 text-purple-400 hover:text-purple-300 text-sm">Open</a>
      </div>
    </div>`;

  async function loadCategory(terms, containerId, limit=12) {
    const el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = '<div class="p-4 text-gray-400">Loading…</div>';
    try {
      let items = [];
      for (const t of terms) {
        const r = await fetch(`${API_BASE}/api/news?limit=${limit}&q=${encodeURIComponent(t)}`);
        const d = await r.json();
        if (Array.isArray(d)) items = items.concat(d);
      }
      const seen = new Set();
      items = items.filter(x => {
        const k = x.id || x.link;
        if (!k || seen.has(k)) return false;
        seen.add(k);
        return true;
      });
      items.sort((a,b)=> new Date(b.pubDate || 0) - new Date(a.pubDate || 0));
      el.innerHTML = items.slice(0, limit).map(articleCard).join('') || '<div class="p-4 text-gray-400">No results.</div>';
      if (window.feather) feather.replace();
    } catch (e) {
      el.innerHTML = '<div class="p-4 text-red-400">Failed to load.</div>';
      console.error(containerId, e);
    }
  }

  // ====== FETCH NEWS ======
  async function fetchNewsAndRender() {
    const featured = document.getElementById('featured');
    const list = document.getElementById('list');
    const trending = document.getElementById('trending');
    if (featured) featured.innerHTML = '<div class="p-6">Loading…</div>';
    if (list) list.innerHTML = '';
    if (trending) trending.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/api/news?limit=40`);
      const data = await res.json();
      ALL_ITEMS = Array.isArray(data) ? data : [];
      if (!ALL_ITEMS.length) throw new Error('Empty');
      buildSourceTabs(ALL_ITEMS);
      renderTrending(ALL_ITEMS);
      applyFilters();
    } catch (e) {
      setHTML(featured, '<div class="p-6 text-red-400">Failed to load news.</div>');
      console.error('NEWS ERROR', e);
    }
  }

  // ====== NAV UX ======
  function initNav() {
    const links = document.querySelectorAll('[data-nav]');
    const mobile = document.getElementById('mobileMenu');
    links.forEach(a => a.addEventListener('click', ()=> mobile.classList.add('hidden')));

    const sections = ['home','news','reviews','guides','community'].map(id=>document.getElementById(id));
    const navs = Array.from(links);
    const io = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if (e.isIntersecting) {
          const id = e.target.id;
          navs.forEach(n => n.classList.toggle('nav-active', n.getAttribute('href') === '#'+id));
        }
      });
    }, {threshold: 0.6});
    sections.forEach(s=>s && io.observe(s));

    document.getElementById('menuBtn').addEventListener('click', ()=> mobile.classList.toggle('hidden'));
  }

  // ====== EVENTS ======
  const moreBtn = document.getElementById('loadMoreBtn');
  if (moreBtn) moreBtn.addEventListener('click', ()=>{ visibleCount += 10; renderList(filtered.slice(1)); });
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) refreshBtn.addEventListener('click', fetchNewsAndRender);
  const searchEl = document.getElementById('searchInput');
  if (searchEl) searchEl.addEventListener('input', (e)=>{ searchTerm = e.target.value; applyFilters(); });

  // ====== BOOT ======
  if (window.feather) feather.replace();
  initNav();
  fetchNewsAndRender();
  // קטגוריות בזמן אמת
  loadCategory(['review','our review','verdict','score','review:'], 'reviews-list', 16);
  loadCategory(['guide','how to','tips','walkthrough'], 'guides-list', 16);
</script>
